#!/usr/bin/env python3
"""
Trading constants, data keys, and visual elements - ENHANCED WITH CONSERVATIVE APPROACH.
REFINED: Added performance tracking and external position constants
PRESERVES: All existing constants and configurations
"""
from decimal import Decimal

# --- TRADING PARAMETERS ---
ENTRY_PORTION_ALLOCATION = [Decimal("0.34"), Decimal("0.33"), Decimal("0.33")]
RISK_PERCENTAGE = "risk_percentage"  # Chat data key for risk percentage

# Conservative approach only - fast approach removed

# Conservative Approach: 4 TPs with specified percentages
TP_PERCENTAGES_CONSERVATIVE = [Decimal("0.85"), Decimal("0.05"), Decimal("0.05"), Decimal("0.05")]
CONSERVATIVE_TP_PERCENTAGES = TP_PERCENTAGES_CONSERVATIVE  # Alias for compatibility

# Default TP percentages
TP_PERCENTAGES = TP_PERCENTAGES_CONSERVATIVE

# Limit order allocation for conservative approach (3 equal parts)
LIMIT_ORDER_ALLOCATION = [Decimal("0.333"), Decimal("0.333"), Decimal("0.334")]

# Bot Identification
BOT_PREFIX = "BOT_"  # Prefix for bot-initiated orders to distinguish from external trades
AUTO_PREFIX = "AUTO_"  # Prefix for auto-generated orders
MANUAL_PREFIX = "MANUAL_"  # Prefix for manually created bot orders

# Bot Position Tracking
BOT_ORDER_PREFIXES = [BOT_PREFIX, AUTO_PREFIX, MANUAL_PREFIX]  # All prefixes that indicate bot orders
MANAGE_EXTERNAL_POSITIONS = False  # Whether to manage positions not created by the bot - SET TO FALSE to protect external trades

# --- VISUAL ELEMENTS ---
EMOJI_MAP = {
    'success': '‚úÖ',
    'error': '‚ùå',
    'warning': '‚ö†Ô∏è',
    'info': '‚ÑπÔ∏è',
    'loading': '‚è≥',
    'rocket': 'üöÄ',
    'money': 'üí∞',
    'chart': 'üìä',
    'shield': 'üõ°Ô∏è',
    'target': 'üéØ',
    'fire': 'üî•',
    'star': '‚≠ê',
    'lightning': '‚ö°',
    'robot': 'ü§ñ',
    'up': 'üìà',
    'down': 'üìâ',
    'neutral': '‚û°Ô∏è',
    'diamond': 'üíé',
    'trophy': 'üèÜ',
    'medal': 'ü•á',
    'check': '‚úîÔ∏è',
    'cross': '‚úñÔ∏è',
    'cross_mark': '‚ùå',
    'thinking': 'ü§î',
    'bulb': 'üí°',
    'gear': '‚öôÔ∏è',
    'refresh': 'üîÑ',
    'pencil': '‚úèÔ∏è',
    'microphone': 'üé§',
    'test_tube': 'üß™',
    'fast': '‚ö°',
    'conservative': 'üõ°Ô∏è',
    'limit': 'üìä',
    'world': 'üåç',
    'brain': 'üß†',
    'green_circle': 'üü¢',
    'red_circle': 'üî¥',
    'yellow_circle': 'üü°',
    'white_circle': '‚ö™',
    'up_chart': 'üìà',
    'down_chart': 'üìâ',
    'mobile': 'üì±',
    'wrench': 'üîß',
    'broom': 'üßπ',
    'stop': 'üõë',
    'checkered_flag': 'üèÅ'
}

# --- chat_data keys ---
SYMBOL = "symbol"
SIDE = "side"
MARGIN_AMOUNT = "margin_amount_usdt"
LEVERAGE = "leverage"
ORDER_STRATEGY = "order_strategy"

# ENHANCED: Trading approach selection including GGShot
TRADING_APPROACH = "trading_approach"
APPROACH_CONSERVATIVE = "conservative_limits"
APPROACH_GGSHOT = "ggshot_screenshot"

# GGShot Screenshot specific constants
GGSHOT_SCREENSHOT_FILE_ID = "ggshot_screenshot_file_id"
GGSHOT_SCREENSHOT_FILE_PATH = "ggshot_screenshot_file_path"
GGSHOT_AI_CONFIDENCE = "ggshot_ai_confidence"
GGSHOT_DETECTED_STRATEGY = "ggshot_detected_strategy"

# Entry prices
PRIMARY_ENTRY_PRICE = "primary_entry_price"
LIMIT_ENTRY_1_PRICE = "limit_entry_1_price"
LIMIT_ENTRY_2_PRICE = "limit_entry_2_price"
LIMIT_ENTRY_3_PRICE = "limit_entry_3_price"

# Take profit prices
TP1_PRICE = "tp1_price"
TP2_PRICE = "tp2_price"
TP3_PRICE = "tp3_price"
TP4_PRICE = "tp4_price"

# Stop loss
SL_PRICE = "sl_price"

# UI and state management
AWAITING_INPUT_FOR = "awaiting_input_for"
LAST_UI_MESSAGE_ID = "last_ui_message_id"
POSITION_IDX = "positionIdx"

# Order IDs
PLACED_LIMIT_ENTRY_IDS = "placed_limit_entry_ids"
MARKET_ORDER_ID = "market_order_id"
TP_ORDER_IDS = "tp_order_ids"
SL_ORDER_ID = "sl_order_id"

# ENHANCED: Conservative approach order tracking
LIMIT_ORDER_IDS = "limit_order_ids"
CONSERVATIVE_TP_ORDER_IDS = "conservative_tp_order_ids"
CONSERVATIVE_SL_ORDER_ID = "conservative_sl_order_id"
CONSERVATIVE_TRADE_GROUP_ID = "conservative_trade_group_id"

# ENHANCED: GGShot approach order tracking
GGSHOT_ENTRY_ORDER_IDS = "ggshot_entry_order_ids"
GGSHOT_TP_ORDER_IDS = "ggshot_tp_order_ids"
GGSHOT_SL_ORDER_ID = "ggshot_sl_order_id"
GGSHOT_TRADE_GROUP_ID = "ggshot_trade_group_id"
GGSHOT_LIMITS_FILLED = "ggshot_limits_filled"

# Instrument info
MIN_ORDER_QTY = "min_order_qty"
MIN_ORDER_NOTIONAL_VALUE = "min_order_notional_value"
INITIAL_MARKET_FILL_QTY = "initial_market_fill_qty"
INITIAL_AVG_ENTRY_PRICE = "initial_avg_entry_price"
ACTIVE_MONITOR_TASK = "active_monitor_task_data_v2"
INSTRUMENT_TICK_SIZE = "instrument_tick_size"
INSTRUMENT_QTY_STEP = "instrument_qty_step"
MARGIN_INPUT_TYPE = "margin_input_type"
MARGIN_PERCENTAGE_VALUE = "margin_percentage_value"
MAX_LEVERAGE_FOR_SYMBOL = "max_leverage_for_symbol"

# AI and risk management
AI_RECOMMENDATIONS_STORE = "ai_recommendations_store"
AI_RISK_ASSESSMENT_STORE = "ai_risk_assessment_store"
USER_OVERRIDE_MARGIN_TYPE = "user_override_margin_type"
USER_OVERRIDE_MARGIN_VALUE_FIXED = "user_override_margin_value_fixed"
USER_OVERRIDE_MARGIN_VALUE_PERCENTAGE = "user_override_margin_value_percentage"
USER_OVERRIDE_LEVERAGE = "user_override_leverage"
USER_OVERRIDE_STRATEGY = "user_override_strategy"
LAST_KNOWN_POSITION_SIZE = "last_known_position_size"
HELP_CONTEXT = "help_context"
USER_PREFERENCES = "user_preferences"
INITIAL_POSITION_MARGIN = "initial_position_margin"
INITIAL_POSITION_VALUE = "initial_position_value"

# ENHANCED: Conservative approach tracking
CONSERVATIVE_LIMITS_FILLED = "conservative_limits_filled"
CONSERVATIVE_TP1_HIT_BEFORE_LIMITS = "conservative_tp1_hit_before_limits"
CONSERVATIVE_TP1_HIT_WITH_FILLS = "conservative_tp1_hit_with_fills"
CONSERVATIVE_TP1_HIT_WITH_FILLS_PROCESSED = "conservative_tp1_hit_with_fills_processed"
CONSERVATIVE_ORDERS_CANCELLED = "conservative_orders_cancelled"

# REFINED: Monitoring and performance tracking
MONITORING_MODE = "monitoring_mode"
AI_RISK_SCORE = "ai_risk_score"
AI_RISK_RATING = "ai_risk_rating"
AI_POSITION_SIZING = "ai_position_sizing"

# AI Recommendation States
AWAIT_AI_RECOMMENDATIONS = 240
DISPLAY_AI_RECOMMENDATIONS = 241
MODIFY_AI_MARGIN_TYPE = 242
MODIFY_AI_MARGIN_VALUE = 243
MODIFY_AI_LEVERAGE = 244
MODIFY_AI_STRATEGY = 245

# Strategy constants
STRATEGY_MARKET_ONLY = "strategy_market_only"
STRATEGY_MARKET_AND_LIMITS = "strategy_market_and_limits"
STRATEGY_CONSERVATIVE_LIMITS = "strategy_conservative_limits"


STATS_TOTAL_TRADES = 'stats_total_trades_initiated'
STATS_TOTAL_WINS = 'stats_total_wins'
STATS_TOTAL_LOSSES = 'stats_total_losses'
STATS_TOTAL_PNL = 'stats_total_pnl'

# Exit Stats
STATS_TP1_HITS = 'stats_tp1_hits'
STATS_SL_HITS = 'stats_sl_hits'
STATS_OTHER_CLOSURES = 'stats_other_closures'

# Streak Stats
STATS_WIN_STREAK = 'stats_win_streak'
STATS_LOSS_STREAK = 'stats_loss_streak'

# Record Stats
STATS_BEST_TRADE = 'stats_best_trade'
STATS_WORST_TRADE = 'stats_worst_trade'

# Approach Stats
STATS_CONSERVATIVE_TRADES = 'stats_conservative_trades'
# Fast approach stats removed
STATS_GGSHOT_TRADES = 'stats_ggshot_trades'
STATS_GGSHOT_AI_SUCCESS_RATE = 'stats_ggshot_ai_success_rate'
STATS_CONSERVATIVE_TP1_CANCELLATIONS = 'stats_conservative_tp1_cancellations'

# Meta Stats
STATS_LAST_RESET = 'stats_last_reset_timestamp'


ACCOUNT_TYPE_PRIMARY = "primary"
ACCOUNT_TYPE_MIRROR = "mirror"

# Mirror Monitoring Keys
MIRROR_MONITOR_TASK = "mirror_monitor_task"
MIRROR_ACTIVE_MONITOR_TASK = "mirror_active_monitor_task"

# Mirror Alert Settings
ENABLE_MIRROR_ALERTS = False  # Disable alerts for mirror account positions to prevent duplicate notifications

# =============================================
# BOT DATA KEYS - EXTERNAL POSITION STATS
# =============================================
STATS_EXTERNAL_TRADES = "stats_external_trades"
STATS_EXTERNAL_PNL = "stats_external_pnl"
STATS_EXTERNAL_WINS = "stats_external_wins"
STATS_EXTERNAL_LOSSES = "stats_external_losses"

# =============================================
# TRADING PARAMETERS
# =============================================
MAX_LEVERAGE = 100
MIN_MARGIN = Decimal("10")
MAX_MARGIN = Decimal("10000")
MIN_POSITION_SIZE = Decimal("1")

# =============================================
# MONITORING PARAMETERS
# =============================================
MONITOR_CHECK_INTERVAL = 8  # seconds
MONITOR_CLEANUP_INTERVAL = 600  # seconds (10 minutes)
MAX_POSITION_HISTORY = 10  # entries
READ_ONLY_MONITORING_CHAT_ID_BASE = 9000000000  # Base for synthetic chat IDs

# =============================================
# PERFORMANCE TRACKING
# =============================================
TRADE_HISTORY_MAX_SIZE = 1000  # Maximum trades to track for duplicate prevention
STATS_DECIMAL_PRECISION = 8  # Decimal places for P&L calculations

# =============================================
# DEFAULT VALUES
# =============================================
DEFAULT_LEVERAGE_OPTIONS = ["1", "2", "3", "5", "10", "15", "20", "25"]
DEFAULT_MARGIN_OPTIONS = ["10", "25", "50", "100", "200", "500"]
DEFAULT_TP_PERCENTAGES = ["0.5", "1", "1.5", "2", "3", "5"]
DEFAULT_SL_PERCENTAGES = ["0.5", "1", "1.5", "2", "3", "5"]

# =============================================
# ERROR MESSAGES
# =============================================
ERROR_MESSAGES = {
    'invalid_symbol': "Invalid symbol format. Please use format like BTCUSDT",
    'invalid_margin': "Invalid margin amount. Must be between $10 and $10,000",
    'invalid_leverage': "Invalid leverage. Must be between 1x and 100x",
    'invalid_price': "Invalid price. Must be a positive number",
    'insufficient_balance': "Insufficient balance for this trade",
    'order_failed': "Order placement failed. Please try again",
    'api_error': "API error occurred. Please try again later",
    'monitoring_error': "Error in position monitoring",
    'calculation_error': "Error in calculations. Please check your inputs"
}

# =============================================
# SUCCESS MESSAGES
# =============================================
SUCCESS_MESSAGES = {
    'trade_placed': "Trade successfully placed!",
    'monitor_started': "Position monitoring started",
    'monitor_stopped': "Position monitoring stopped",
    'orders_cancelled': "Orders cancelled successfully",
    'stats_reset': "Performance stats reset successfully",
    'position_closed': "Position closed successfully"
}


(SELECTING_ACTION, ENTERING_SYMBOL, SELECTING_SIDE, ENTERING_MARGIN,
 SELECTING_LEVERAGE, ENTERING_TP, ENTERING_SL, CONFIRMING_TRADE,
 ENTERING_MULTIPLE_TPS, ENTERING_LIMIT_ORDERS, SELECTING_APPROACH,
 UPLOADING_SCREENSHOT, MONITORING_POSITION) = range(13)

# Legacy conversation states for compatibility
(
    ASK_SYMBOL,
    ASK_SIDE,
    ASK_APPROACH_SELECTION,  # NEW: Added approach selection
    ASK_ORDER_STRATEGY,
    ASK_PRIMARY_ENTRY_PRICE,
    ASK_L1_PRICE,
    ASK_L2_PRICE,
    ASK_L3_PRICE,  # NEW: Third limit order
    ASK_TP1_PRICE,
    ASK_TP2_PRICE,
    ASK_TP3_PRICE,
    ASK_TP4_PRICE,
    ASK_SL_PRICE,
    AWAIT_AI_RECOMMENDATIONS,
    DISPLAY_AI_RECOMMENDATIONS,
    HANDLE_MANUAL_MARGIN_SETUP_TYPE,
    HANDLE_MANUAL_MARGIN_SETUP_FIXED_AMOUNT,
    HANDLE_MANUAL_MARGIN_SETUP_PERCENTAGE_VALUE,
    HANDLE_MANUAL_LEVERAGE_SETUP,
    HANDLE_MANUAL_STRATEGY_SETUP,
    REVIEW_TRADE_WITH_FINAL_PARAMS
) = range(21)  # Updated range to accommodate new states

# =============================================
# EXPORT ALL CONSTANTS
# =============================================
__all__ = [
    # Trading Parameters
    'ENTRY_PORTION_ALLOCATION', 'TP_PERCENTAGES_CONSERVATIVE',
    'CONSERVATIVE_TP_PERCENTAGES', 'TP_PERCENTAGES', 'LIMIT_ORDER_ALLOCATION', 'RISK_PERCENTAGE',

    # Visual Elements
    'EMOJI_MAP',

    # Chat Data Keys - Basic
    'SYMBOL', 'SIDE', 'MARGIN_AMOUNT', 'LEVERAGE', 'ORDER_STRATEGY',

    # GGShot Screenshot Keys
    'GGSHOT_SCREENSHOT_FILE_ID', 'GGSHOT_SCREENSHOT_FILE_PATH',
    'GGSHOT_AI_CONFIDENCE', 'GGSHOT_DETECTED_STRATEGY',

    # Chat Data Keys - Prices
    'PRIMARY_ENTRY_PRICE', 'LIMIT_ENTRY_1_PRICE', 'LIMIT_ENTRY_2_PRICE',
    'LIMIT_ENTRY_3_PRICE', 'TP1_PRICE', 'TP2_PRICE', 'TP3_PRICE', 'TP4_PRICE',
    'SL_PRICE',

    # Chat Data Keys - UI/State
    'AWAITING_INPUT_FOR', 'LAST_UI_MESSAGE_ID', 'POSITION_IDX',

    # Chat Data Keys - Orders
    'PLACED_LIMIT_ENTRY_IDS', 'MARKET_ORDER_ID', 'TP_ORDER_IDS', 'SL_ORDER_ID',
    'LIMIT_ORDER_IDS', 'CONSERVATIVE_TP_ORDER_IDS', 'CONSERVATIVE_SL_ORDER_ID',
    'CONSERVATIVE_TRADE_GROUP_ID',

    # GGShot Order Keys
    'GGSHOT_ENTRY_ORDER_IDS', 'GGSHOT_TP_ORDER_IDS', 'GGSHOT_SL_ORDER_ID',
    'GGSHOT_TRADE_GROUP_ID', 'GGSHOT_LIMITS_FILLED',

    # Chat Data Keys - Instrument
    'MIN_ORDER_QTY', 'MIN_ORDER_NOTIONAL_VALUE', 'INITIAL_MARKET_FILL_QTY',
    'INITIAL_AVG_ENTRY_PRICE', 'ACTIVE_MONITOR_TASK', 'INSTRUMENT_TICK_SIZE',
    'INSTRUMENT_QTY_STEP', 'MARGIN_INPUT_TYPE', 'MARGIN_PERCENTAGE_VALUE',
    'MAX_LEVERAGE_FOR_SYMBOL',

    # Chat Data Keys - AI/Risk
    'AI_RECOMMENDATIONS_STORE', 'AI_RISK_ASSESSMENT_STORE', 'AI_RISK_SCORE',
    'AI_RISK_RATING', 'AI_POSITION_SIZING',

    # Chat Data Keys - User Overrides
    'USER_OVERRIDE_MARGIN_TYPE', 'USER_OVERRIDE_MARGIN_VALUE_FIXED',
    'USER_OVERRIDE_MARGIN_VALUE_PERCENTAGE', 'USER_OVERRIDE_LEVERAGE',
    'USER_OVERRIDE_STRATEGY',

    # Chat Data Keys - Monitoring
    'LAST_KNOWN_POSITION_SIZE', 'MONITORING_MODE', 'HELP_CONTEXT',
    'USER_PREFERENCES', 'INITIAL_POSITION_MARGIN', 'INITIAL_POSITION_VALUE',

    # Conservative Approach Tracking
    'CONSERVATIVE_LIMITS_FILLED', 'CONSERVATIVE_TP1_HIT_BEFORE_LIMITS',
    'CONSERVATIVE_TP1_HIT_WITH_FILLS', 'CONSERVATIVE_TP1_HIT_WITH_FILLS_PROCESSED',
    'CONSERVATIVE_ORDERS_CANCELLED',

    # AI States
    'AWAIT_AI_RECOMMENDATIONS', 'DISPLAY_AI_RECOMMENDATIONS',
    'MODIFY_AI_MARGIN_TYPE', 'MODIFY_AI_MARGIN_VALUE',
    'MODIFY_AI_LEVERAGE', 'MODIFY_AI_STRATEGY',

    # Strategy Constants
    'STRATEGY_MARKET_ONLY', 'STRATEGY_MARKET_AND_LIMITS',
    'STRATEGY_CONSERVATIVE_LIMITS',

    # Performance Stats Keys
    'STATS_TOTAL_TRADES', 'STATS_TOTAL_WINS', 'STATS_TOTAL_LOSSES',
    'STATS_TOTAL_PNL', 'STATS_TP1_HITS', 'STATS_SL_HITS', 'STATS_OTHER_CLOSURES',
    'STATS_WIN_STREAK', 'STATS_LOSS_STREAK', 'STATS_BEST_TRADE',
    'STATS_WORST_TRADE', 'STATS_CONSERVATIVE_TRADES',
    'STATS_GGSHOT_TRADES', 'STATS_GGSHOT_AI_SUCCESS_RATE',
    'STATS_CONSERVATIVE_TP1_CANCELLATIONS', 'STATS_LAST_RESET',

    # External Stats Keys
    'STATS_EXTERNAL_TRADES', 'STATS_EXTERNAL_PNL', 'STATS_EXTERNAL_WINS',
    'STATS_EXTERNAL_LOSSES',

    # Trading Parameters
    'MAX_LEVERAGE', 'MIN_MARGIN', 'MAX_MARGIN', 'MIN_POSITION_SIZE',

    # Monitoring Parameters
    'MONITOR_CHECK_INTERVAL', 'MONITOR_CLEANUP_INTERVAL',
    'MAX_POSITION_HISTORY', 'READ_ONLY_MONITORING_CHAT_ID_BASE',

    # Performance Tracking
    'TRADE_HISTORY_MAX_SIZE', 'STATS_DECIMAL_PRECISION',

    # Default Values
    'DEFAULT_LEVERAGE_OPTIONS', 'DEFAULT_MARGIN_OPTIONS',
    'DEFAULT_TP_PERCENTAGES', 'DEFAULT_SL_PERCENTAGES',

    # Messages
    'ERROR_MESSAGES', 'SUCCESS_MESSAGES',

    # States
    'SELECTING_ACTION', 'ENTERING_SYMBOL', 'SELECTING_SIDE', 'ENTERING_MARGIN',
    'SELECTING_LEVERAGE', 'ENTERING_TP', 'ENTERING_SL', 'CONFIRMING_TRADE',
    'ENTERING_MULTIPLE_TPS', 'ENTERING_LIMIT_ORDERS', 'SELECTING_APPROACH',
    'UPLOADING_SCREENSHOT', 'MONITORING_POSITION',

    # Legacy States
    'ASK_SYMBOL', 'ASK_SIDE', 'ASK_APPROACH_SELECTION', 'ASK_ORDER_STRATEGY',
    'ASK_PRIMARY_ENTRY_PRICE', 'ASK_L1_PRICE', 'ASK_L2_PRICE', 'ASK_L3_PRICE',
    'ASK_TP1_PRICE', 'ASK_TP2_PRICE', 'ASK_TP3_PRICE', 'ASK_TP4_PRICE',
    'ASK_SL_PRICE', 'HANDLE_MANUAL_MARGIN_SETUP_TYPE',
    'HANDLE_MANUAL_MARGIN_SETUP_FIXED_AMOUNT',
    'HANDLE_MANUAL_MARGIN_SETUP_PERCENTAGE_VALUE',
    'HANDLE_MANUAL_LEVERAGE_SETUP', 'HANDLE_MANUAL_STRATEGY_SETUP',
    'REVIEW_TRADE_WITH_FINAL_PARAMS',

    # Mirror Account Monitoring
    'ACCOUNT_TYPE_PRIMARY', 'ACCOUNT_TYPE_MIRROR',
    'MIRROR_MONITOR_TASK', 'MIRROR_ACTIVE_MONITOR_TASK',
    'ENABLE_MIRROR_ALERTS'
]